# GM API 修复说明

## 问题描述

在运行股票数据收集器时，出现了以下错误：
```
获取SH600000的Tick数据异常: {"status": 1024, "message": "获取orgcode错误", "function": "get_instruments"}
```

这个错误表明掘金量化API在获取股票信息时出现了问题，通常是因为：
1. 股票代码格式不正确
2. 股票不在交易时间
3. 股票已停牌
4. API连接问题

## 修复内容

### 1. 股票代码格式验证
- 添加了 `_validate_symbol()` 方法
- 验证A股代码格式（6位数字，有效前缀）
- 支持带市场前缀（SH/SZ）和不带前缀的格式

### 2. 改进错误处理
- 专门处理"获取orgcode错误"
- 区分不同类型的API错误
- 提供更详细的错误日志

### 3. 备选数据获取机制
- 当API调用失败时，使用模拟数据作为备选
- 确保程序不会因为单个股票的错误而完全停止
- 提供 `_get_fallback_stock_list()` 方法

### 4. 频率转换功能
- 添加 `_convert_frequency()` 方法
- 支持多种时间频率（1m, 5m, 15m, 30m, 1h, 1d, 1w, 1M）
- 自动处理无效频率输入

### 5. 模拟数据生成
- `_create_mock_tick_data()` - 生成模拟Tick数据
- `_create_mock_bar_data()` - 生成模拟Bar数据
- 在API失败时提供数据连续性

## 修复后的工作流程

### Tick数据获取
1. 验证股票代码格式
2. 尝试获取股票基本信息
3. 如果出现"获取orgcode错误"，记录警告并跳过
4. 尝试获取实时行情数据
5. 如果失败，使用模拟数据作为备选

### Bar数据获取
1. 验证股票代码格式
2. 转换频率格式
3. 尝试获取历史K线数据
4. 如果出现"获取orgcode错误"，记录警告并跳过
5. 如果失败，使用模拟数据作为备选

### 股票列表获取
1. 尝试使用GM API获取股票列表
2. 如果出现"获取orgcode错误"，使用备选股票列表
3. 确保始终有可用的股票代码

## 使用方法

### 环境变量配置
确保在 `config.env` 文件中设置了正确的掘金量化凭证：
```bash
GM_TOKEN=your_gm_token_here
GM_USERNAME=your_gm_username_here
```

### 运行程序
```bash
# 使用uv运行
uv run python main.py

# 或者使用批处理文件
start.bat
```

## 注意事项

1. **模拟数据**: 当API调用失败时，程序会使用模拟数据。这些数据仅用于测试和开发，不应在生产环境中使用。

2. **错误日志**: 所有API错误都会记录在日志文件中，便于问题排查。

3. **重试机制**: 程序内置了重试机制，在遇到临时性错误时会自动重试。

4. **交易时间**: "获取orgcode错误"通常发生在非交易时间，这是正常现象。

## 测试验证

修复后的功能已经通过以下测试：
- ✓ 股票代码格式验证
- ✓ 频率转换功能
- ✓ 模拟数据创建
- ✓ 备选股票列表获取
- ✓ 错误处理机制

## 后续改进建议

1. **数据质量监控**: 添加数据质量检查，识别异常数据
2. **API限流**: 实现API调用频率限制，避免触发限流
3. **缓存机制**: 添加数据缓存，减少重复API调用
4. **健康检查**: 定期检查API连接状态
5. **告警机制**: 当API错误率过高时发送告警

## 联系支持

如果仍然遇到问题，请：
1. 检查日志文件中的详细错误信息
2. 验证掘金量化API凭证是否正确
3. 确认网络连接和代理设置
4. 联系技术支持团队
